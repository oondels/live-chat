<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Chat</title>
    <link rel="icon" href="assets/img/icon/favicon.ico" type="image/x-icon" />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/static/styles.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
  </head>
  <body>
    <div class="main">
      <div class="users-container">
        <i
          id="button-users-online"
          class="icon-users-online material-symbols-outlined"
        >
          groups
        </i>
        <div id="users-online-content">
          <h2>Usuários Online</h2>
          <ul id="users-online" class="users-list"></ul>
        </div>
      </div>

      <div class="container">
        <div class="hello">
          <h1 id="user">Olá</h1>
        </div>
        <form id="chat">
          <div class="messages"></div>
          <input name="message" placeholder="Digit your message" type="text" />
          <button type="submit">
            <i class="fas fa-paper-plane"></i> Send Message
          </button>
        </form>
        <button id="logout">Logout</button>
      </div>
    </div>

    <script type="text/javascript">
      const token = localStorage.getItem("token");

      var socket = io("http://localhost:2399");

      let user;

      if (!token) {
        window.location.href = "http://localhost:2399/login";
      } else {
        fetch("http://localhost:2399/protected", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            if (data) {
              if (data.redirect) {
                return (window.location.href = data.redirect);
              }

              user = data;
              socket.emit("userLogged", user);

              document.getElementById("user").innerText += ` ${user.user}`;
            } else {
              return (window.location.href = "http://localhost:2399/login");
            }
          })
          .catch((err) => {
            return console.error("Erro:", err);
          });
      }

      const logout = document.getElementById("logout");
      logout.addEventListener("click", () => {
        fetch("http://localhost:2399/auth/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((data) => {
            if (data.ok) {
              return data.json();
            } else {
              throw new Error("Falha no logout");
            }
          })
          .then((response) => {
            console.log(response);
            return (window.location.href = "http://localhost:2399/home");
          })
          .catch((error) => {
            console.error("Erro no logout:", error);
          });
      });

      // Mostrar Usuários Online
      const userButton = document.querySelector("#button-users-online");
      userButton.addEventListener("click", () => {
        const userOnlineContent = document.querySelector(
          "#users-online-content"
        );

        if (userOnlineContent.classList.contains("show")) {
          userOnlineContent.classList.remove("show");
        } else {
          userOnlineContent.classList.add("show");
        }
      });

      const scrollToBottom = () => {
        const messagesDiv = document.querySelector(".messages");
        setTimeout(() => {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 0);
      };

      const renderMessages = (message) => {
        if (message.username === user.user) {
          $(".messages").append(
            "<div class='message sent'><strong>" +
              message.username +
              "</strong>: " +
              message.message +
              "</div>"
          );
        } else {
          $(".messages").append(
            "<div class='message'><strong>" +
              message.username +
              "</strong>: " +
              message.message +
              "</div>"
          );
        }

        setTimeout(() => {
          scrollToBottom();
        }, 0);
      };

      socket.on("onlineUsers", (users) => {
        const usersContainer = document.getElementById("users-online");
        usersContainer.innerHTML = "";

        users.forEach((user) => {
          const userItem = document.createElement("li");
          userItem.textContent = user.user;
          userItem.classList.add("user-item");
          usersContainer.appendChild(userItem);
        });
      });

      socket.on("previousMessage", (messages) => {
        for (message of messages) {
          renderMessages(message);
        }
      });

      socket.on("newMessage", (message) => {
        renderMessages(message);
      });

      $("#chat").submit((event) => {
        event.preventDefault();
        var message = $("input[name=message]").val();

        if (message.length) {
          var messageObject = {
            author: user,
            message: message,
          };

          socket.emit("messageSend", messageObject);
          $("input[name=message]").val("");
        }
      });
    </script>
  </body>
</html>
